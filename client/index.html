<!doctype html>
<html lang="en" ng-app="clicky">
	<head>
		<title>Clicky</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

		<style>
			* {
				font-family: Roboto, Arial, sans-serif;
				font-weight: 700;
			}
			
			body {
				margin: 0;
				padding: 0;
			    overflow: hidden;
			}
			
			.head {
				text-align: center;
			}
			.title {
				animation: pulse 0.58s infinite;
			}
			
			.bar {
				height: 30px;
				background-image: url(https://i.imgur.com/YSrjDS7.gif);
				background-position: center;
				background-size: contain;
				transition: ease-out width 50ms;
			}
			
			.players .destroyers {
				display: inline-block;
			}
			.players .creators {
				display: inline-block;
				float: right;
			}
			
			@keyframes pulse {
				0% {
					transform: scale(1);
					opacity: 1;
				}
				70% {
					transform: scale(1.2);
					opacity: .5;
				}
				100% {
					transform: scale(1);
					opacity: 1;
				}
			}
		</style>
	</head>
	<body>
		<div id="app" ng-controller="ClickyCtrl">
			<div class="head">
				<h1 class="title">Clicky</h1>
				<h3 class="role" ng-show="playerId">{{players[playerId].role | capitalize}}!</h3>
			</div>
			
			<div class="bar" style="width: calc(100% / {{clicky.max}} * {{clicky.stringCount}})"></div>
			
			<div class="join-form" ng-show="!playerId">
				<form ng-submit="joinGame()">
					<input type="text" ng-model="playerName" value="Name"/>
					<input type="submit" value="Join game">
				</form>
			</div>
			
			<div class="players">
				<div class="destroyers">
					<h3>Destroyers</h3>
					<p ng-repeat="(id, player) in players" ng-if="player.role == 'destroy'">{{player.name}}</p>
				</div>
				<div class="creators">
					<h3>Creators</h3>
					<p ng-repeat="(id, player) in players" ng-if="player.role == 'create'">{{player.name}}</p>
				</div>
			</div>
			
			<audio src="https://jukebox-redux.herokuapp.com/api/tracks/mp3?artist=bee gees&track=stayin alive" autoplay loop></audio>
		</div>
		<script src="/socket.io/socket.io.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.6/angular.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.6/angular-animate.js"></script>
		<script>
			/* global angular, io*/
			var app = angular.module('clicky', ['ngAnimate']);
			
			app.filter('capitalize', function() {
				return function(input) {
					return (!!input) ? input.charAt(0).toUpperCase() + input.substr(1).toLowerCase() : '';
				};
			});
			
			app.controller('ClickyCtrl', function($scope, $document) {
				
				const socket = io.connect();
				
				$scope.clicky = {};
				$scope.players = {};
				$scope.playerId = null;
				
				// Global keypress key codes
				const keys = {
					makeMove: 32 // 'spacebar'
				};

				socket.on('newGame', ({role, game}) => {
					$scope.role = role;
					$scope.clicky = game;
					$scope.$apply();
				});
				
				$scope.joinGame = function() {
					socket.emit('joinGame', {playerName: $scope.playerName});
				};
				
				socket.on('allPlayers', ({players, playerId}) => {
					$scope.playerId = playerId;
					$scope.players = players;
					$scope.$apply();
					console.log(players);
				});
				
				socket.on('newPlayer', player => {
					$scope.players[player.id] = player;
					$scope.$apply();
				});
				
				socket.on('playerLeft', playerId => {
					delete $scope.players[playerId];
					$scope.$apply();
				});
				
				$document.bind('keydown', e => {
					if (e.keyCode === keys.makeMove && !event.repeat) {
						$scope.makeMove();
					}
				});
				
				$document.bind('touchstart', e => {
					$scope.makeMove();
				});

				$scope.makeMove = function() {
					socket.emit('makeMove');
				};
				
				socket.on('madeMove', newLength => {
					$scope.clicky.stringCount = newLength;
					$scope.$apply();
				});
				
				socket.on('gameOver', function({winner, stringCount}) {
					$scope.clicky.stringCount = stringCount;
					// alert(winner + ' win!');
				});
				
				$scope.range = function(n) {
					return new Array(n);
				};
			});
		</script>
	</body>
</html>
